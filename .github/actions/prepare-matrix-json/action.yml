name: Prepare matrix JSON for modules/environments
description: Builds modules_json and matrix_json for matrix strategy
inputs:
  modules:
    description: "Comma-separated list of modules (e.g. 'api,cronjob')"
    required: true
    default: "api,cronjob"
  environments:
    description: "Comma-separated list of environments (e.g. 'prod,staging')"
    required: true
    default: "prod"
  release_name:
    description: |
      Optional single release name to attach to all matrix entries.
      Example: "googlecalendartoluma-api".
      If omitted/empty, releaseName defaults to the module name.
    required: false
    default: ""

outputs:
  modules_json:
    description: "Matrix JSON for modules only"
    value: ${{ steps.modules.outputs.modules_json }}
  matrix_json:
    description: "Full matrix JSON for module+environment (+ releaseName)"
    value: ${{ steps.matrix.outputs.matrix_json }}

runs:
  using: composite
  steps:
    - id: modules
      name: Construct modules-only matrix JSON
      shell: bash
      run: |
        set -euo pipefail

        MODULES_JSON='{"include":['
        IFS=',' read -ra MODULES <<< "${{ inputs.modules }}"
        for module in "${MODULES[@]}"; do
          [[ -z "$module" ]] && continue
          MODULE_LOWER=$(echo "$module" | tr '[:upper:]' '[:lower:]')
          MODULES_JSON+='{"module":"'"$module"'","module_lower":"'"$MODULE_LOWER"'"},'
        done
        MODULES_JSON=${MODULES_JSON%,}
        MODULES_JSON+=']}'

        echo "Modules JSON: $MODULES_JSON"
        echo "modules_json=$MODULES_JSON" >> "$GITHUB_OUTPUT"

    - id: matrix
      name: Construct full matrix JSON
      shell: bash
      run: |
        set -euo pipefail

        MODULES_STR="${{ inputs.modules }}"
        ENVS_STR="${{ inputs.environments }}"
        RELEASE_NAME_INPUT="${{ inputs.release_name }}"

        IFS=',' read -ra MODULES <<< "$MODULES_STR"
        IFS=',' read -ra ENVIRONMENTS <<< "$ENVS_STR"

        MATRIX_JSON='{"include":['

        for ENV in "${ENVIRONMENTS[@]}"; do
          for MODULE in "${MODULES[@]}"; do
            [[ -z "$MODULE" ]] && continue

            MODULE_LOWER=$(echo "$MODULE" | tr '[:upper:]' '[:lower:]')

            if [[ -n "$RELEASE_NAME_INPUT" ]]; then
              RELEASE_NAME="$RELEASE_NAME_INPUT"
            else
              RELEASE_NAME="$MODULE"
            fi

            MATRIX_JSON+="{\"environment\":\"$ENV\",\"module\":\"$MODULE\",\"module_lower\":\"$MODULE_LOWER\",\"releaseName\":\"$RELEASE_NAME\"},"
          done
        done

        MATRIX_JSON="${MATRIX_JSON%,}]}"
        echo "MATRIX_JSON=$MATRIX_JSON"
        echo "matrix_json=$MATRIX_JSON" >> "$GITHUB_OUTPUT"
